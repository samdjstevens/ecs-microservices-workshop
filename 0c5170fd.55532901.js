(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{64:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return a})),n.d(t,"toc",(function(){return i})),n.d(t,"default",(function(){return l}));var r=n(3),c=(n(0),n(88));const s={id:"writing-constructs",title:"Writing constructs",sidebar_label:"Writing constructs",slug:"/writing-constructs"},a={unversionedId:"writing-constructs",id:"writing-constructs",isDocsHomePage:!1,title:"Writing constructs",description:'Constructs are the "basic building blocks of CDK apps" - they represent a "cloud component", be it a single resource like an EC2 instance or an S3 bucket - or a higher level component consisting of several AWS resources all working together.',source:"@site/docs/writing-constructs.md",slug:"/writing-constructs",permalink:"/ecs-microservices-workshop/writing-constructs",editUrl:"https://github.com/samdjstevens/ecs-microservices-workshop/edit/master/docs/writing-constructs.md",version:"current",sidebar_label:"Writing constructs",sidebar:"someSidebar",previous:{title:"Adding the frontend service",permalink:"/ecs-microservices-workshop/frontend-service"},next:{title:"Conclusion",permalink:"/ecs-microservices-workshop/conclusion"}},i=[{value:"Creating a Construct",id:"creating-a-construct",children:[{value:"Create the Construct",id:"create-the-construct",children:[]},{value:"Defining construct properties",id:"defining-construct-properties",children:[]},{value:"Porting over the code",id:"porting-over-the-code",children:[]},{value:"Retrieving data from constructs",id:"retrieving-data-from-constructs",children:[]},{value:"Using the construct in the stack",id:"using-the-construct-in-the-stack",children:[]}]}],o={toc:i};function l({components:e,...t}){return Object(c.b)("wrapper",Object(r.a)({},o,t,{components:e,mdxType:"MDXLayout"}),Object(c.b)("p",null,Object(c.b)("a",{parentName:"p",href:"https://docs.aws.amazon.com/cdk/latest/guide/constructs.html"},"Constructs"),' are the "basic building blocks of CDK apps" - they represent a "cloud component", be it a single resource like an ',Object(c.b)("a",{parentName:"p",href:"https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-ec2.Instance.html"},"EC2 instance")," or an ",Object(c.b)("a",{parentName:"p",href:"https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-s3.Bucket.html"},"S3 bucket")," - or a higher level component consisting of several AWS resources all working together."),Object(c.b)("p",null,"In this workshop we've used lots of different constructs, ranging from simple single resource components, to very high level ones that create many resources."),Object(c.b)("p",null,"When ",Object(c.b)("a",{parentName:"p",href:"/ecs-microservices-workshop/frontend-service"},"creating the frontend service"),", we used the ",Object(c.b)("inlineCode",{parentName:"p"},"ApplicationLoadBalancedFargateService")," construct from the ",Object(c.b)("inlineCode",{parentName:"p"},"ecs-patterns")," module. This construct creates all the AWS resources needed for a publically available, load balanced Fargate service - the ECS task definition and service, the Application Load Balancer, and all the other various bits and pieces needed."),Object(c.b)("p",null,"These higher level constructs are very useful as they enable developers to create complex AWS architecture with a small amount of code. Configuration for the constructs can be provided to alter how they are deployed or behave, and the authors of the construct can provide sensible defaults."),Object(c.b)("p",null,"Constructs can also be used across an organisation to ensure that components are architected following best practices and policy requirements."),Object(c.b)("h2",{id:"creating-a-construct"},"Creating a Construct"),Object(c.b)("p",null,"We will extract the CDK we wrote to create the backend service into its own ",Object(c.b)("inlineCode",{parentName:"p"},"BackendService")," construct, so that it is reusable."),Object(c.b)("p",null,"We, and other developers, can then use this to bring up a backend service, where we just need to specify the things that are unique - the container image, the service name, etc."),Object(c.b)("h3",{id:"create-the-construct"},"Create the Construct"),Object(c.b)("p",null,"Create a new file called ",Object(c.b)("inlineCode",{parentName:"p"},"lib/backend-service.ts")," in the stack project, and place the following code inside:"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-javascript",metastring:'title="lib/backend-service.ts"',title:'"lib/backend-service.ts"'},"import { Construct } from 'constructs';\n\nexport interface BackendServiceProps {\n}\n\nexport class BackendService extends Construct {\n\n  constructor(scope: Construct, id: string, props: BackendServiceProps) {\n    super(scope, id);\n  }\n}\n")),Object(c.b)("p",null,"This is the bare bones skeleton for a construct. At the top we define the schema for the properties/configuration for the construct (currently empty) and below we define the resources that the construct will create for us."),Object(c.b)("h3",{id:"defining-construct-properties"},"Defining construct properties"),Object(c.b)("p",null,"We start by defining what properties/configuration our construct will accept."),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-javascript",metastring:'title="lib/backend-service.ts"{2,5-9}',title:'"lib/backend-service.ts"{2,5-9}'},"import { Construct } from 'constructs';\nimport { aws_ecs as ecs, aws_iam as iam } from 'aws-cdk-lib';\n\nexport interface BackendServiceProps {\n  cluster: ecs.Cluster;\n  containerImage: ecs.ContainerImage;\n  instances: number;\n  serviceName: string;\n  taskRoleManagedPolicies: iam.IManagedPolicy[]\n}\n\nexport class BackendService extends Construct {\n\n  constructor(scope: Construct, id: string, props: BackendServiceProps) {\n    super(scope, id);\n  }\n}\n")),Object(c.b)("p",null,"The construct will ask for the ECS cluster in which the service is to be created - note that this is the Construct object, not a name. So users of this construct can create/retrieve the cluster in whatever they want, and pass it in the props."),Object(c.b)("p",null,"We also ask for the container image to run, the number of instances of the container to be up at any given time, the name of the service, and an array of any Managed IAM Policies that the container should have attached."),Object(c.b)("p",null,"These are all things that are ",Object(c.b)("strong",{parentName:"p"},"unique to our service")," - everything else would be the same across different backend applications."),Object(c.b)("h3",{id:"porting-over-the-code"},"Porting over the code"),Object(c.b)("p",null,"Now we can port the code over from our stack into the construct, making small changes here and there to use the properties provided by the user of the construct."),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-javascript",metastring:'title="lib/backend-service.ts"{17-53}',title:'"lib/backend-service.ts"{17-53}'},"import { Construct } from 'constructs';\nimport { aws_ec2 as ec2, aws_ecs as ecs, aws_iam as iam } from 'aws-cdk-lib';\n\nexport interface BackendServiceProps {\n  cluster: ecs.Cluster;\n  containerImage: ecs.ContainerImage;\n  instances: number;\n  serviceName: string;\n  taskRoleManagedPolicies: iam.IManagedPolicy[]\n}\n\nexport class BackendService extends Construct {\n\n  constructor(scope: Construct, id: string, props: BackendServiceProps) {\n    super(scope, id);\n\n    // Create the task definition\n    const taskDefinition = new ecs.FargateTaskDefinition(this, id + '_TaskDefinition');\n\n    // Add all the managed policies to the task role\n    for (let policy of props.taskRoleManagedPolicies) {\n        taskDefinition.taskRole.addManagedPolicy(policy);\n    }\n\n    // Add the container to the task definition\n    const container = taskDefinition.addContainer('app', {\n        image: props.containerImage,\n        logging: new ecs.AwsLogDriver({ streamPrefix: props.serviceName })\n    })\n\n    // Expose port 80 on the container\n    container.addPortMappings({\n        containerPort: 80,\n        hostPort: 80\n    })\n\n    // Allow inbound traffic from within the VPC on port 80\n    const appTaskDefinitionSecurityGroup = new ec2.SecurityGroup(this, id + '_ServiceSecurityGroup', {\n        vpc: props.cluster.vpc,\n        securityGroupName: props.serviceName  + '-sg'\n    })\n    appTaskDefinitionSecurityGroup.addIngressRule(ec2.Peer.ipv4(this.cluster.vpc.vpcCidrBlock), ec2.Port.tcp(80));\n\n    // Create the ECS service\n    const service = new ecs.FargateService(this, id + '_Service', {\n        cluster: props.cluster,\n        taskDefinition: taskDefinition,\n        desiredCount: props.instances,\n        securityGroups: [appTaskDefinitionSecurityGroup],\n        cloudMapOptions: {\n            name: props.serviceName\n        }\n    })\n\n  }\n}\n")),Object(c.b)("p",null,"We've made some tweaks here and there to the code to use the props of the construct, but it is pretty much the same."),Object(c.b)("h3",{id:"retrieving-data-from-constructs"},"Retrieving data from constructs"),Object(c.b)("p",null,"Sometimes we will want to retireve data or child constructs from constructs so that we can use them in the stack. For our stack, we have an output that shows the URL of the backend service. "),Object(c.b)("p",null,"Add the highlighted lines below to define a readonly property of the construct, which will expose the URL of the service being created."),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-javascript",metastring:'title="lib/backend-service.ts"{7,24}',title:'"lib/backend-service.ts"{7,24}'},"import { Stack, StackProps, CfnOutput } from 'aws-cdk-lib';\n\n...\n\nexport class BackendService extends Construct {\n\n  public readonly serviceUrl: string;\n\n  constructor(scope: Construct, id: string, props: BackendServiceProps) {\n    \n        ...\n\n        // Create the ECS service\n        const service = new ecs.FargateService(this, id + '_Service', {\n            cluster: props.cluster,\n            taskDefinition: translateApiTaskDefinition,\n            desiredCount: props.instances,\n            securityGroups: [appTaskDefinitionSecurityGroup],\n            cloudMapOptions: {\n                name: props.serviceName\n            }\n        })\n\n        this.serviceUrl = \"http://\" + service.cloudMapService!.serviceName + \".\" + service.cloudMapService!.namespace.namespaceName;\n\n  }\n}\n")),Object(c.b)("h3",{id:"using-the-construct-in-the-stack"},"Using the construct in the stack"),Object(c.b)("p",null,"We can now delete lines X-X in the stack and add the highlighted lines:"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-javascript",metastring:'title="lib/translatr-cdk-stack.ts" {4,22-32}',title:'"lib/translatr-cdk-stack.ts"',"{4,22-32}":!0},"import { Stack, StackProps } from 'aws-cdk-lib';\nimport { Construct } from 'constructs';\nimport { aws_ec2 as ec2, aws_ecs as ecs, aws_iam as iam, aws_servicediscovery as servicediscovery } from 'aws-cdk-lib';\nimport { BackendService } from './backend-service';\n\nexport class TranslatrCdkStack extends Stack {\n  constructor(scope: Construct, id: string, props?: StackProps) {\n    super(scope, id, props);\n\n    ...\n\n    const cluster = new ecs.Cluster(this, 'EcsCluster', {\n        vpc,\n        clusterName: 'translatr',\n        defaultCloudMapNamespace: {\n            name: 'local',\n            type: servicediscovery.NamespaceType.DNS_PRIVATE,\n            vpc\n        }\n    })\n\n    const backend = new Backend(this, 'TranslateBackendService', {\n        cluster,\n        containerImage: ecs.ContainerImage.fromRegistry('public.ecr.aws/f0u6x9s9/ecs-microservices-translate-api'),\n        instances: 3,\n        serviceName: 'translate-api',\n        taskRoleManagedPolicies: [\n            iam.ManagedPolicy.fromAwsManagedPolicyName('TranslateFullAccess')\n        ]\n    })\n\n    let translateApiUrl = backend.serviceUrl\n\n    ...\n\n  }\n}\n")),Object(c.b)("p",null,"The stack is now using the ",Object(c.b)("inlineCode",{parentName:"p"},"BackendService")," construct!"))}l.isMDXComponent=!0},88:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var r=n(0),c=n.n(r);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,c=function(e,t){if(null==e)return{};var n,r,c={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(c[n]=e[n]);return c}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(c[n]=e[n])}return c}var l=c.a.createContext({}),p=function(e){var t=c.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return c.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return c.a.createElement(c.a.Fragment,{},t)}},h=c.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,a=e.parentName,l=o(e,["components","mdxType","originalType","parentName"]),u=p(n),h=r,b=u["".concat(a,".").concat(h)]||u[h]||d[h]||s;return n?c.a.createElement(b,i(i({ref:t},l),{},{components:n})):c.a.createElement(b,i({ref:t},l))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,a=new Array(s);a[0]=h;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i.mdxType="string"==typeof e?e:r,a[1]=i;for(var l=2;l<s;l++)a[l]=n[l];return c.a.createElement.apply(null,a)}return c.a.createElement.apply(null,n)}h.displayName="MDXCreateElement"}}]);